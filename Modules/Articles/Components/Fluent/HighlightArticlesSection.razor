@using Microsoft.FluentUI.AspNetCore.Components
@using snowcoreBlog.Frontend.SharedComponents.Components.Fluent
@using snowcoreBlog.PublicApi.BusinessObjects.Dto
@using snowcoreBlog.PublicApi.Extensions

<FluentStack Orientation="Orientation.Vertical">
	<FluentSpacer />
	<FluentSpacer />
	<FluentSpacer />

	@if (Articles is null || !Articles.Any())
	{
		<div class="no-articles">No articles yet.</div>
	}
	else
	{
		var three = Articles.OrderByDescending(a => a.PublishedAt ?? DateTime.MinValue).Take(3).ToArray();
		<div class="row g-3 align-items-stretch highlight-grid">
			@if (three.Length >= 1)
			{
				<div class="col-12 col-md-8">
					<a class="d-flex flex-column text-decoration-none text-reset h-100" href="@GetArticleUrl(three[0])" aria-label="@three[0].Title">
						<FloatingCard Style="display: contents;">
							<div class="highlight-main-image w-100"></div>
							<div class="p-3 highlight-main-body d-flex flex-column gap-2 flex-grow-1">
								<h3 class="title mb-0">@three[0].Title</h3>
								<p class="meta mb-0">@FormatDate(three[0].PublishedAt) • @string.Join(", ", three[0].AuthorUserIds ?? new Guid[0])</p>
								<p class="excerpt mt-auto mb-0">@Excerpt(three[0].Markdown)</p>
							</div>
						</FloatingCard>
					</a>
				</div>
			}

			<div class="col-12 col-md-4 d-flex flex-column justify-content-between highlight-side">
				@if (three.Length >= 2)
				{
					<a class="d-flex align-items-center gap-3 text-decoration-none text-reset mb-3 side-item" href="@GetArticleUrl(three[1])" aria-label="@three[1].Title">
						<FloatingCard Style="display: contents;">
							<div class="side-thumb flex-shrink-0"></div>
							<div class="side-body">
								<h4 class="title mb-0">@three[1].Title</h4>
								<p class="meta mb-0">@FormatDate(three[1].PublishedAt)</p>
							</div>
						</FloatingCard>
					</a>
				}

				@if (three.Length >= 3)
				{
					<a class="d-flex align-items-center gap-3 text-decoration-none text-reset side-item" href="@GetArticleUrl(three[2])" aria-label="@three[2].Title">
						<FloatingCard Style="display: contents;">
							<div class="side-thumb flex-shrink-0"></div>
							<div class="side-body">
								<h4 class="title mb-0">@three[2].Title</h4>
								<p class="meta mb-0">@FormatDate(three[2].PublishedAt)</p>
							</div>
						</FloatingCard>
					</a>
				}
			</div>
		</div>
	}

	<FluentSpacer />
</FluentStack>

@code
{
	[Parameter]
	public IEnumerable<ArticleDto>? Articles { get; set; }

	private string GetArticleUrl(ArticleDto article) => $"/articles/{(article.Slug ?? article.Id.ToString())}";

	private string Excerpt(string? markdown, int max = 160)
	{
		if (string.IsNullOrWhiteSpace(markdown))
			return string.Empty;

		// Strip basic markdown-ish characters for a short excerpt
		var s = System.Text.RegularExpressions.Regex.Replace(markdown, @"[#>*`\[\]\(\)]", string.Empty);
		s = System.Text.RegularExpressions.Regex.Replace(s, @"\s+", " ").Trim();
		if (s.Length <= max) return s;
		return s.Substring(0, max).TrimEnd() + "…";
	}

	private string FormatDate(DateTime? dt) => dt?.ToString("MMM d, yyyy") ?? string.Empty;
}