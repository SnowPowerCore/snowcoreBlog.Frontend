@using Soenneker.Blazor.Masonry
@using snowcoreBlog.PublicApi.BusinessObjects.Dto
@using snowcoreBlog.Frontend.SharedComponents.Components.Fluent

<div class="articles-list-section">
    @if (Articles is null || !Articles.Skip(3).Any())
    {
        <div class="no-more">No more articles.</div>
    }
    else
    {
        <Masonry AutoRender="true" SizerClass="col-sm-1" @ref="_masonry" class="row masonry">
            @foreach (var a in Articles.Skip(3))
            {
                <MasonryItem class="col-lg-4 col-md-6 mb-4">
                    <a class="masonry-item-link" href="@GetArticleUrl(a)" aria-label="@a.Title">
                        <FloatingCard Class="masonry-card p-0 position-relative d-flex flex-column">
                            @if (!string.IsNullOrWhiteSpace(a.CoverImageUrl))
							{
								<img src="@a.CoverImageUrl" alt="@a.Title" class="position-absolute top-0 start-0 w-100 h-100 object-fit-cover" />
							}
                            <div class="masonry-tint position-absolute top-0 start-0 w-100 h-100" style="background: linear-gradient(to bottom, rgba(0,0,0,0.5), rgba(0,0,0,0.85));"></div>
                            <div class="flex-grow-1" style="min-height: 200px;"></div>
                            <div class="masonry-body d-flex flex-column gap-2 p-0 position-relative">
                                <h4 class="title">@a.Title</h4>
                                <p class="meta">@FormatDate(a.PublishedAt)</p>
                                <p class="excerpt">@Excerpt(a.Markdown)</p>
                            </div>
                        </FloatingCard>
                    </a>
                </MasonryItem>
            }
        </Masonry>
    }
</div>

@code
{
	[Parameter]
	public IEnumerable<ArticleDto>? Articles { get; set; }

	private Masonry _masonry = null!;

	private string GetArticleUrl(ArticleDto article) => $"/articles/{(article.Slug ?? article.Id.ToString())}";

	private string Excerpt(string? markdown, int max = 140)
	{
		if (string.IsNullOrWhiteSpace(markdown)) return string.Empty;
		var s = System.Text.RegularExpressions.Regex.Replace(markdown, @"[#>*`\[\]\(\)]", string.Empty);
		s = System.Text.RegularExpressions.Regex.Replace(s, @"\s+", " ").Trim();
		return s.Length <= max ? s : s.Substring(0, max).TrimEnd() + "…";
	}

	private string FormatDate(DateTime? dt) => dt?.ToString("MMM d, yyyy") ?? string.Empty;
}